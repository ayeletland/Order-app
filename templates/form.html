<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>הזמנת פריטים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f7f7f9; }
    .sticky-top-lite { position:sticky; top:0; z-index:1020; background:#fff; border-bottom:1px solid #eee; }
    .qty-input { max-width: 110px; }
    .muted { color:#6c757d; font-size:.9rem; }
    .table thead th { white-space: nowrap; }
    .filters .form-select, .filters .form-control { min-width: 180px; }
    .customer-box { background:#fff; border:1px solid #eee; border-radius: .75rem; }
  </style>
</head>
<body>

<div class="container py-3">

  <!-- כותרת + כפתורי אדמין -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0">📦 הזמנת פריטים</h3>
      <div class="muted">בחרי לקוח, סנני פריטים והקלידי כמויות &gt; 0</div>
    </div>

    {% if is_admin %}
      <div class="d-flex gap-2">
        <!-- ייצוא SAP -->
        <a class="btn btn-outline-primary"
           href="/admin/export?admin=1"
           title="ייצוא מלא ל-SAP (CSV)">
          📄 ייצוא ל-SAP
        </a>
      </div>
    {% endif %}
  </div>

  <!-- בחירת לקוח -->
  <div class="customer-box p-3 mb-3">
    <form method="get" action="/" class="row g-2 align-items-end">
      {% if is_admin %}
        <input type="hidden" name="admin" value="1" />
      {% endif %}

      <div class="col-md-3">
        <label class="form-label">סינון לפי מנהל מכירות</label>
        <select class="form-select" name="sales_manager" onchange="this.form.submit()">
          <option value="">כל המנהלים</option>
          {% for sm in sales_managers %}
            <option value="{{ sm }}" {% if request.args.get('sales_manager') == sm %}selected{% endif %}>{{ sm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">חיפוש לקוח (מספר או שם)</label>
        <input class="form-control" type="text" name="customer_search"
               value="{{ request.args.get('customer_search','') }}"
               placeholder="כתבי מספר או שם לקוח ולחצי אנטר" />
      </div>

      <div class="col-md-4">
        <label class="form-label">בחרי לקוח</label>
        <select class="form-select" name="customer_id" onchange="this.form.submit()" required>
          <option value="">— בחרי לקוח —</option>
          {% for c in customers %}
            <option value="{{ c['CustomerID'] }}"
                    {% if selected_customer == c['CustomerID'] %}selected{% endif %}>
              {{ c['CustomerID'] }} – {{ c['CustomerName'] }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-1">
        <button class="btn btn-secondary w-100" type="submit" title="רענון רשימת לקוחות">סינון</button>
      </div>
    </form>
  </div>

  <!-- סינוני פריטים (נפתחים אחרי בחירת לקוח) -->
  {% if selected_customer %}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" action="/" class="row g-2 filters">
        {% if is_admin %}<input type="hidden" name="admin" value="1"/>{% endif %}
        <input type="hidden" name="customer_id" value="{{ selected_customer }}"/>

        <div class="col-md-3">
          <label class="form-label">Domain</label>
          <select class="form-select" name="domain" onchange="this.form.submit()">
            {% if domains and domains|length > 0 %}
              {% for d in domains %}
                <option value="{{ d if d != '(All)' else '' }}"
                  {% if (request.args.get('domain','') == '' and d=='(All)') or (request.args.get('domain')==d) %}selected{% endif %}>
                  {{ d }}
                </option>
              {% endfor %}
            {% else %}
              <option value="">—</option>
            {% endif %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Category</label>
          <select class="form-select" name="category" onchange="this.form.submit()">
            {% if categories and categories|length > 0 %}
              {% for c in categories %}
                <option value="{{ c if c != '(All)' else '' }}"
                  {% if (request.args.get('category','') == '' and c=='(All)') or (request.args.get('category')==c) %}selected{% endif %}>
                  {{ c }}
                </option>
              {% endfor %}
            {% else %}
              <option value="">—</option>
            {% endif %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">SubCategory</label>
          <select class="form-select" name="subcat" onchange="this.form.submit()">
            {% if subcats and subcats|length > 0 %}
              {% for s in subcats %}
                <option value="{{ s if s != '(All)' else '' }}"
                  {% if (request.args.get('subcat','') == '' and s=='(All)') or (request.args.get('subcat')==s) %}selected{% endif %}>
                  {{ s }}
                </option>
              {% endfor %}
            {% else %}
              <option value="">—</option>
            {% endif %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">חיפוש פריט (מק״ט / שם)</label>
          <div class="input-group">
            <input class="form-control" type="text" name="item_search"
                   value="{{ request.args.get('item_search','') }}"
                   placeholder="מק״ט או שם פריט" />
            <button class="btn btn-outline-secondary" type="submit">חיפוש</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- טופס הזמנה (נפתח אחרי בחירת לקוח) -->
  {% if selected_customer %}
  <form method="post" action="/" class="card shadow-sm">
    <div class="card-body">

      <input type="hidden" name="customer_id" value="{{ selected_customer }}" />
      {% if is_admin %}<input type="hidden" name="admin" value="1" />{% endif %}

      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">תאריך אספקה (אופציונלי)</label>
          <input type="date" class="form-control" name="delivery_date" />
        </div>
        <div class="col-md-9 text-end">
          <button type="submit" class="btn btn-primary">
            ✅ שלחי הזמנה
          </button>
        </div>
      </div>

      <!-- טבלת פריטים -->
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>מק״ט</th>
              <th>שם פריט</th>
              <th>Domain</th>
              <th>Category</th>
              <th>SubCategory</th>
              <th style="width:140px;">כמות להזמנה</th>
            </tr>
          </thead>
          <tbody>
            {% if items and items|length > 0 %}
              {% for it in items %}
              <tr>
                <td><code>{{ it['ItemCode'] }}</code></td>
                <td>{{ it['ItemDescription'] }}</td>
                <td>{{ it['Domain'] }}</td>
                <td>{{ it['Category'] }}</td>
                <td>{{ it['SubCategory'] }}</td>
                <td>
                  <input class="form-control qty-input" type="number" min="0" step="1"
                         name="qty_{{ it['ItemCode'] }}" placeholder="0" />
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted">אין פריטים להצגה תחת הסינון הנוכחי.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-primary">
          ✅ שלחי הזמנה
        </button>
      </div>
    </div>
  </form>
  {% endif %}

  <div class="mt-4 text-center text-muted">
    {% if is_admin %}מצב אדמין פעיל — ניתן לייצא ל-SAP מהכפתור למעלה.{% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
