<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>הזמנה</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 10px; }
    header, form, table { max-width: 1100px; margin: 0 auto; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size:14px; display:block; }
    input, select, button { padding:8px; font-size:14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border:1px solid #ccc; padding:6px 8px; vertical-align: middle; }
    th { background:#f6f6f6; position: sticky; top:0; }
    .qty { width:90px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin: 8px auto; max-width:1100px;}
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>

<header class="toolbar">
  <div class="muted">
    <strong>סל:</strong> {{ cart_size }} פריטים |
    <a href="{{ url_for('cart_view') }}">לסל</a>
  </div>
  <div class="muted"><a href="/health" target="_blank">health</a></div>
</header>

<form method="get" action="{{ url_for('order_form') }}">
  <div class="row">
    <div>
      <label>מנהל/ת מכירות</label>
      <select name="sales_manager" onchange="this.form.submit()">
        <option value="">— הכל —</option>
        {% for sm in sales_managers %}
          <option value="{{ sm }}" {% if sm==sales_manager %}selected{% endif %}>{{ sm }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>חיפוש לקוח (שם/מס’)</label>
      <input type="text" name="customer_search" value="{{ customer_search }}" placeholder="לדוגמה: איילון / 2824…" />
    </div>

    <div>
      <label>בחירת לקוח</label>
      <select name="customer_id" onchange="this.form.submit()">
        <option value="">— בחר/י —</option>
        {% for c in customers %}
          <option value="{{ c.CustomerNumber }}" {% if selected_customer and c.CustomerNumber==selected_customer.CustomerNumber %}selected{% endif %}>
            {{ c.Display }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>פריטים להצגה</label>
      <select name="items_scope" onchange="this.form.submit()">
        <option value="customer" {% if items_scope=='customer' %}selected{% endif %}>פריטי לקוח</option>
        <option value="all" {% if items_scope=='all' %}selected{% endif %}>כלל הפריטים</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <div>
      <label>Domain</label>
      <select name="domain" onchange="this.form.submit()">
        <option value="">— הכל —</option>
        {% for d in domains %}
          <option value="{{ d }}" {% if d==domain %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Category</label>
      <select name="category" onchange="this.form.submit()">
        <option value="">— הכל —</option>
        {% for cat in categories %}
          <option value="{{ cat }}" {% if cat==category %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>SubCategory</label>
      <select name="subcategory" onchange="this.form.submit()">
        <option value="">— הכל —</option>
        {% for sc in subcategories %}
          <option value="{{ sc }}" {% if sc==subcategory %}selected{% endif %}>{{ sc }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="flex:1;">
      <label>חיפוש בפריטים (קוד / שם / דומיין/קטגוריה)</label>
      <input type="text" name="q" value="{{ q }}" style="width:100%" placeholder="הקלד/י טקסט…"/>
    </div>
    <div>
      <button type="submit">סנן</button>
    </div>
  </div>
</form>

<form method="post" action="{{ url_for('order_form') }}">
  <!-- נשמר את כל פרמטרי הסינון כדי לא לאבד מצב -->
  <input type="hidden" name="sales_manager" value="{{ sales_manager }}">
  <input type="hidden" name="customer_search" value="{{ customer_search }}">
  <input type="hidden" name="customer_id" value="{{ customer_id }}">
  <input type="hidden" name="items_scope" value="{{ items_scope }}">
  <input type="hidden" name="domain" value="{{ domain }}">
  <input type="hidden" name="category" value="{{ category }}">
  <input type="hidden" name="subcategory" value="{{ subcategory }}">
  <input type="hidden" name="q" value="{{ q }}">

  <table>
    <thead>
      <tr>
        <th>Domain</th>
        <th>Category</th>
        <th>SubCategory</th>
        <th>קוד</th>
        <th>שם פריט</th>
        <th>כמות</th>
      </tr>
    </thead>
    <tbody>
      {% for r in items %}
        <tr>
          <td>{{ r.Domain }}</td>
          <td>{{ r.Category }}</td>
          <td>{{ r.SubCategory }}</td>
          <td>{{ r.ItemCode }}</td>
          <td>{{ r.ItemName }}</td>
          <td>
            <input class="qty" type="number" min="0" name="qty" value="{{ r.QtyInCart or 0 }}" />
            <input type="hidden" name="code" value="{{ r.ItemCode }}" />
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="toolbar">
    <div class="muted">ממויין לפי Domain → Category → SubCategory → שם פריט</div>
    <div>
      <button type="submit">שמור כמויות</button>
      <a href="{{ url_for('cart_view') }}"><button type="button">לסל</button></a>
    </div>
  </div>
</form>

</body>
</html>
